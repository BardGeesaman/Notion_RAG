version: "3.9"

services:
  jupyterhub:
    build:
      context: ../..
      dockerfile: deploy/jupyterhub/Dockerfile
    container_name: amprenta-jupyterhub

    ports:
      - "8888:8888"

    environment:
      - API_URL=${API_URL:-http://host.docker.internal:8000}

    volumes:
      # DockerSpawner needs access to the host Docker daemon
      - /var/run/docker.sock:/var/run/docker.sock
      # Persist hub db and runtime files
      - jupyterhub-db:/srv/jupyterhub
    networks:
      - jupyterhub-network

    restart: unless-stopped

  # Build-only service to produce the single-user image expected by DockerSpawner.
  # Run: docker compose build singleuser
  singleuser:
    profiles: ["build"]
    build:
      context: ../..
      dockerfile: deploy/jupyterhub/singleuser/Dockerfile
    image: amprenta-singleuser:latest
    command: ["bash", "-lc", "echo singleuser image built"]
    restart: "no"
    networks:
      - jupyterhub-network

volumes:
  jupyterhub-db:

networks:
  jupyterhub-network:
    name: jupyterhub-network


