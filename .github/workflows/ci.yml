name: CI

on:
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements.txt"
      - name: Install ruff
        run: python -m pip install --upgrade pip ruff
      - name: Ruff check
        run: ruff check .

  mypy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install mypy types-requests types-PyYAML types-redis
      - name: Run mypy
        run: python -m mypy amprenta_rag --config-file mypy.ini

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pytest-cov
      - name: Run tests with coverage
        run: pytest -m "not requires_server" --ignore=amprenta_rag/tests/dashboard/ --cov=amprenta_rag --cov-report=term --cov-fail-under=48
        env:
          DATABASE_URL: "sqlite:///:memory:"
          DISABLE_AUTH: "true"

  terraform-validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: deploy/aws/terraform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.8.5"
      - name: Terraform init (no backend)
        run: terraform init -backend=false
      - name: Terraform validate
        run: terraform validate

